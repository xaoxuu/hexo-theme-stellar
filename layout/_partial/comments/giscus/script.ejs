<script>
  (function() {
    const lazyload = <%= theme.comments.lazyload ?? false %>;
    
    function initGiscus() {
      const el = document.querySelector('#comments #giscus');
      if (!el) return;
      
      function load_giscus() {
        try {
          el.innerHTML = '';
        } catch (error) {
          console.error(error);
        }
        const script = document.createElement('script');
        script.async = true;
        for (const key of Object.keys(el.attributes)) {
          const attr = el.attributes[key];
          if (['class', 'id'].includes(attr.name) === false) {
            script.setAttribute(attr.name, attr.value);
          }
        }
        el.appendChild(script);
      }
      
      util.viewportLazyload(el, load_giscus, lazyload);
    }
    
    // Store in global stellar namespace for PJAX reinitialization
    window.stellar = window.stellar || {};
    window.stellar.initComments = window.stellar.initComments || {};
    window.stellar.initComments.giscus = initGiscus;
    
    // Initialize on page load
    initGiscus();
  })();
</script>
