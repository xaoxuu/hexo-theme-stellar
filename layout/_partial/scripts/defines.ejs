<%
  const canonical = theme.canonical || {}
  const encoded = Buffer.from(canonical.originalHost || '').toString('base64');
  const canonicalWithEncoded = Object.assign({}, canonical, {
    encoded: encoded
  });
  const permalink = page.permalink || canonical.originalHost;
  const checklink = theme.data_services.video.js
%>

<script type="text/javascript">
  window.canonical = <%- JSON.stringify(canonicalWithEncoded) %>;
  window.canonical["param"] = <%- JSON.stringify({permalink, checklink}) %>;
  // Fix: Ensure page is at the correct top position on data load
  if (history.scrollRestoration) {
    history.scrollRestoration = 'manual';
  }
  (function() {
    const scrollHandler = () => {
      // Only scroll if user hasn't already scrolled
      const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
      if (currentScroll > 0) {
        return; // User has scrolled, don't interfere
      }
      
      const wikiCover = document.querySelector('#l_cover .l_cover.wiki');
      const startEl = document.getElementById('start');
      if (wikiCover && startEl) {
        window.scrollTo(0, startEl.offsetTop);
      } else {
        window.scrollTo(0, 0);
      }
    };
    
    // Use requestAnimationFrame to avoid layout thrashing during page load
    if (document.readyState !== 'loading') {
      requestAnimationFrame(scrollHandler);
    } else {
      document.addEventListener('DOMContentLoaded', () => requestAnimationFrame(scrollHandler));
    }
  })();
  const ctx = {
    date_suffix: {
      just: `<%- __('meta.date_suffix.just') %>`,
      min: `<%- __('meta.date_suffix.min') %>`,
      hour: `<%- __('meta.date_suffix.hour') %>`,
      day: `<%- __('meta.date_suffix.day') %>`,
    },
    root : `<%- config.root %>`,
    tag_plugins: {
      chat: Object.assign(<%- JSON.stringify(theme.tag_plugins.chat) %>),
    }
  };

  // required plugins (only load if needs)
  if (`<%- theme.search.service %>`) {
    ctx.search = {};
    ctx.search.service = `<%- theme.search.service %>`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `<%- JSON.stringify(theme.search.local_search) %>`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `<%- theme.default.avatar %>`,
    cover: `<%- theme.default.cover %>`,
    loading: `<%- theme.default.loading %>`,
  };
  const deps = {
    jquery: `<%- url_for(theme.dependencies.jquery) %>`,
    marked: `<%- url_for(theme.dependencies.marked) %>`,
    lazyload: `<%- url_for(theme.dependencies.lazyload) %>`
  }
</script>
